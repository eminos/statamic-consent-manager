class d{constructor(t){this.cookieName="consent_manager",this.cookieExpiry=180,this.cookiePath="/",this.cookieDomain=null,this.cookieSecure=!1,this.cookieSameSite="lax",this.consentData={services:{},revision_date:null},this.categories=[],this.services=[],this.categoryIndex={},this.currentRevisionDate=null,this.pendingReload=!1,this.debug=!1,this.integrations=[],this.integrationsPayload={},this.init()}registerIntegration(t){t&&typeof t.loadConfig=="function"&&typeof t.getName=="function"&&typeof t.isEnabled=="function"&&typeof t.applyConsentUpdate=="function"&&(t.loadConfig(this.integrationsPayload),t.isEnabled()&&(this.integrations.push(t),this.debug&&console.log(`[Consent Manager] Registered integration: ${t.getName()}`),t.applyConsentUpdate()))}init(){this.loadPayload(),this.loadConsentFromCookie(),this.bindEvents(),this.syncUIFromConsent(),this.updateDialogVisibility(),this.activateDeferredScripts()}loadPayload(){const t=document.querySelector('[data-consent-manager="payload"]');if(t)try{const e=JSON.parse(t.textContent);this.categories=Array.isArray(e.categories)?e.categories:[],this.buildCategoryIndex(),this.services=Array.isArray(e.services)?e.services:[],this.currentRevisionDate=e.consent_revision_date||null,this.cookieName=e.cookie_name||"consent_manager",this.cookieExpiry=e.cookie_expiry||180,this.cookiePath=e.cookie_path||"/",this.cookieDomain=e.cookie_domain||null,this.cookieSecure=e.cookie_secure===!0,this.cookieSameSite=e.cookie_same_site||"lax",this.debug=e.debug===!0,this.debug&&(console.log("[Consent Manager] Debug mode enabled"),console.log("[Consent Manager] Current revision date:",this.currentRevisionDate),console.log("[Consent Manager] Cookie name:",this.cookieName),console.log("[Consent Manager] Cookie expiry (days):",this.cookieExpiry),console.log("[Consent Manager] Cookie secure:",this.cookieSecure),console.log("[Consent Manager] Cookie same site:",this.cookieSameSite));const a=e.integrations;this.integrationsPayload=a&&typeof a=="object"&&!Array.isArray(a)?a:{}}catch(e){console.warn("Invalid consent manager payload:",e)}}buildCategoryIndex(){this.categoryIndex={},this.categories.forEach(t=>{t&&typeof t.handle=="string"&&t.handle.length&&(this.categoryIndex[t.handle]=t)})}ensureServicePreferences(){(!this.consentData.services||typeof this.consentData.services!="object")&&(this.consentData.services={}),this.services.forEach(t=>{if(!(!t||typeof t.handle!="string"||!t.handle.length)&&!(t.handle in this.consentData.services)){let e=!1;t.categories&&t.categories.length>0&&(e=t.categories.some(a=>{const s=this.categoryIndex[a];return s&&s.required})),this.consentData.services[t.handle]=e}})}applyAllIntegrationUpdates(){this.debug&&console.log(`[Consent Manager] Applying updates to ${this.integrations.length} integration(s)`),this.integrations.forEach(t=>{t.isEnabled()&&t.applyConsentUpdate()})}loadConsentFromCookie(){const t=this.getCookie(this.cookieName);if(t)try{const e=JSON.parse(t);this.consentData={services:e.services||{},revision_date:e.revision_date||null}}catch(e){console.warn("Invalid consent cookie:",e)}else this.consentData.services=this.consentData.services||{};this.ensureServicePreferences()}saveConsentToCookie(){this.consentData.revision_date=this.currentRevisionDate;const t=JSON.stringify(this.consentData),e=new Date;e.setTime(e.getTime()+this.cookieExpiry*24*60*60*1e3);const a="expires="+e.toUTCString();let s=`${this.cookieName}=${t};${a};path=${this.cookiePath}`;this.cookieDomain&&(s+=`;domain=${this.cookieDomain}`),this.cookieSecure&&(s+=";secure"),s+=`;SameSite=${this.cookieSameSite.charAt(0).toUpperCase()+this.cookieSameSite.slice(1)}`,document.cookie=s,this.debug&&(console.log("[Consent Manager] Saved consent with revision date:",this.currentRevisionDate),console.log("[Consent Manager] Cookie attributes:",{path:this.cookiePath,domain:this.cookieDomain,secure:this.cookieSecure,sameSite:this.cookieSameSite}))}getCookie(t){const e=t+"=",a=(document.cookie||"").split(";");for(let s=0;s<a.length;s++){let i=a[s];for(;i.charAt(0)===" ";)i=i.substring(1);if(i.indexOf(e)===0)return i.substring(e.length,i.length)}return null}bindEvents(){const t=document.querySelector('[data-consent-manager="banner"]'),e=document.querySelector('[data-consent-manager="preferences"]');t?.querySelectorAll("[data-consent-manager-action]")?.forEach(n=>{n.addEventListener("click",()=>{const o=n.getAttribute("data-consent-manager-action");if(o==="customize"){this.openPreferencesDialog();return}const r=this.handleAction(o);["accept-all","reject-all"].includes(o)&&this.closeDialogs(),r&&this.requestPageReload()})}),e?.querySelectorAll("[data-consent-manager-action]")?.forEach(n=>{n.addEventListener("click",()=>{const o=n.getAttribute("data-consent-manager-action"),r=this.handleAction(o);["save","accept-all","reject-all"].includes(o)&&this.closeDialogs(),r&&this.requestPageReload()})}),(e?.querySelectorAll("[data-consent-accordion-toggle]")||[]).forEach(n=>{n.addEventListener("click",()=>{const o=n.closest("[data-consent-category]")?.querySelector("[data-consent-accordion-panel]");if(!o)return;const r=o.hasAttribute("hidden");r?(o.removeAttribute("hidden"),n.setAttribute("data-open","true")):(o.setAttribute("hidden",""),n.removeAttribute("data-open"));const c=n.querySelector("[data-accordion-label]");if(c){const l=n.getAttribute("data-label-show")||"Show services",h=n.getAttribute("data-label-hide")||"Hide services";c.textContent=r?h:l}})}),(e?.querySelectorAll("[data-consent-manager-service-toggle]")||[]).forEach(n=>{n.addEventListener("change",()=>{const o=n.getAttribute("data-consent-manager-service-toggle"),r=n.checked;this.syncServiceToggles(o,r,n)})}),(e?.querySelectorAll("[data-consent-manager-toggle]")||[]).forEach(n=>{n.addEventListener("click",o=>{if(n.hasAttribute("data-required")&&n.getAttribute("data-required")==="true"||!n.indeterminate)return;const c=n.getAttribute("data-consent-manager-toggle"),l=n.closest(`[data-consent-category="${c}"]`);l&&(o.preventDefault(),n.dataset.skipNextCategoryChange="true",this.applyCategoryToggle(l,n,!0),n.dispatchEvent(new Event("change",{bubbles:!0})))}),n.addEventListener("change",()=>{if(n.hasAttribute("data-required")&&n.getAttribute("data-required")==="true")return;if(n.dataset.skipNextCategoryChange==="true"){delete n.dataset.skipNextCategoryChange;return}const r=n.getAttribute("data-consent-manager-toggle"),c=n.closest(`[data-consent-category="${r}"]`);c&&this.applyCategoryToggle(c,n,n.checked)})}),e?.addEventListener("cancel",n=>{n.preventDefault(),this.closePreferencesDialog()}),e?.addEventListener("click",n=>{if(n.target!==e)return;const o=e.getBoundingClientRect();n.clientX>=o.left&&n.clientX<=o.right&&n.clientY>=o.top&&n.clientY<=o.bottom||this.closePreferencesDialog()}),this.bindGiveConsentButtons()}bindGiveConsentButtons(){document.querySelectorAll("[data-give-consent]").forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-give-consent");e&&this.grantConsentToService(e)})})}openBannerDialog(){const t=document.querySelector('[data-consent-manager="banner"]');t&&!t.open&&t.show()}openPreferencesDialog(){const t=document.querySelector('[data-consent-manager="banner"]'),e=document.querySelector('[data-consent-manager="preferences"]');t?.close(),e?.showModal(),e?.focus(),this.syncUIFromConsent()}closePreferencesDialog(){document.querySelector('[data-consent-manager="preferences"]')?.close()}closeDialogs(){const t=document.querySelector('[data-consent-manager="banner"]'),e=document.querySelector('[data-consent-manager="preferences"]');t?.close(),e?.close()}handleAction(t){const e=this.getCookie(this.cookieName)!==null,a=this.getAllConsent();switch(t){case"accept-all":this.services.forEach(n=>{!n||!n.handle||(this.consentData.services[n.handle]=!0)});break;case"reject-all":this.consentData={services:{},revision_date:null},this.services.forEach(n=>{!n||!n.handle||(this.consentData.services[n.handle]=!1)});break;case"save":document.querySelectorAll('[data-consent-manager="preferences"] [data-consent-manager-service-toggle]')?.forEach(n=>{const o=n.getAttribute("data-consent-manager-service-toggle");if(!o)return;const r=n.checked;this.consentData.services[o]=r});break;default:return!1}this.ensureServicePreferences(),this.saveConsentToCookie(),this.syncUIFromConsent(),this.updateDialogVisibility(),this.dispatchUpdateEvent(),this.activateDeferredScripts(),this.applyAllIntegrationUpdates();const s=e?this.detectRevocations(a,this.consentData):!1;return this.pendingReload=s,s}syncServiceToggles(t,e,a=null){if(!t)return;(document.querySelectorAll(`[data-consent-manager-service-toggle="${t}"]`)||[]).forEach(i=>{a&&i===a||i instanceof HTMLInputElement&&(i.disabled||(i.checked=e))}),this.recalculateCategoriesForService(t)}applyCategoryToggle(t,e,a){if(e.hasAttribute("data-required")&&e.getAttribute("data-required")==="true")return;e.indeterminate=!1,e.checked=a,t.querySelectorAll("[data-consent-manager-service-toggle]").forEach(n=>{if(n instanceof HTMLInputElement&&!n.disabled){n.checked=a;const o=n.getAttribute("data-consent-manager-service-toggle");this.syncServiceToggles(o,n.checked,n)}}),this.recalculateCategoryState(t)}syncUIFromConsent(){document.querySelectorAll("[data-consent-manager-service-toggle]").forEach(e=>{const a=e.getAttribute("data-consent-manager-service-toggle");if(a in(this.consentData.services||{}))e.checked=!!this.consentData.services[a];else{const s=this.services.find(i=>i.handle===a);if(s&&s.categories&&s.categories.length>0){const i=s.categories.some(n=>{const o=this.categoryIndex[n];return o&&o.default_enabled});e.checked=i}}}),this.recalculateAllCategoryStates()}recalculateAllCategoryStates(){(document.querySelectorAll("[data-consent-category]")||[]).forEach(e=>this.recalculateCategoryState(e))}recalculateCategoriesForService(t){const e=document.querySelectorAll(`[data-consent-manager-service-toggle="${t}"]`)||[],a=new Set;e.forEach(s=>{const i=s.closest("[data-consent-category]");i&&a.add(i)}),a.forEach(s=>this.recalculateCategoryState(s))}recalculateCategoryState(t){const e=t.querySelector("[data-consent-manager-toggle]");if(!e)return;const a=e.hasAttribute("data-required")&&e.getAttribute("data-required")==="true",s=Array.from(t.querySelectorAll("[data-consent-manager-service-toggle]")).filter(r=>r instanceof HTMLInputElement);if(a){e.checked=!0,e.indeterminate=!1;return}if(s.length===0){e.indeterminate=!1,e.checked=!1;return}const i=s.reduce((r,c)=>r+(c.checked?1:0),0),n=i===s.length,o=i===0;e.indeterminate=!1,n?e.checked=!0:o?e.checked=!1:(e.checked=!1,e.indeterminate=!0)}updateDialogVisibility(){const t=this.getCookie(this.cookieName)!==null,e=this.needsReconsent(),a=document.querySelector('[data-consent-manager="banner"]'),s=document.querySelector('[data-consent-manager="preferences"]');t&&!e?(a?.close(),s?.close()):(this.openBannerDialog(),s?.close()),this.debug&&e&&console.log("[Consent Manager] Re-consent required - revision date changed")}needsReconsent(){return this.currentRevisionDate?this.consentData.revision_date?this.consentData.revision_date!==this.currentRevisionDate:!0:!1}dispatchUpdateEvent(){const t={consentData:this.consentData},e=this.integrations.filter(s=>s.isEnabled());e.length>0&&(t.integrations={},e.forEach(s=>{const i=s.getState();i&&(t.integrations[s.getName()]=i)}));const a=new CustomEvent("consent-manager:preferences-updated",{detail:t});document.dispatchEvent(a)}activateDeferredScripts(){this.getCookie(this.cookieName)!==null&&this.services.forEach(e=>{e.handle&&this.getServiceConsent(e.handle)&&this.activateTemplatesForService(e.handle)})}activateTemplatesForService(t){if(!t)return;document.querySelectorAll(`template[data-consent-manager-script][data-service-handle="${t}"]`).forEach(a=>{document.querySelector(`[data-consent-placeholder="${t}"]`)?.remove(),a.before(a.content),a.remove()})}detectRevocations(t,e){const a=t?.services||{},s=e?.services||{};return Object.keys(a).some(n=>a[n]===!0&&s[n]!==!0)}requestPageReload(){this.pendingReload&&(this.pendingReload=!1,window.setTimeout(()=>window.location.reload(),100))}grantConsentToService(t){t&&(this.consentData.services||(this.consentData.services={}),this.consentData.services[t]=!0,this.saveConsentToCookie(),this.activateTemplatesForService(t),this.dispatchUpdateEvent(),this.applyAllIntegrationUpdates(),this.debug&&console.log(`[Consent Manager] Granted consent to service: ${t}`))}getServiceConsent(t){return!this.consentData||!this.consentData.services?!1:this.consentData.services[t]===!0}showBanner(){this.openBannerDialog()}showPreferences(){this.openPreferencesDialog()}getAllConsent(){return JSON.parse(JSON.stringify(this.consentData))}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.consentManager=new d}):window.consentManager=new d;

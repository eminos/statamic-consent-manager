class d{constructor(e){this.cookieName="consent_manager",this.cookieExpiry=180,this.cookiePath="/",this.cookieDomain=null,this.cookieSecure=!1,this.cookieSameSite="lax",this.consentData={services:{},revision_date:null},this.categories=[],this.services=[],this.categoryIndex={},this.currentRevisionDate=null,this.pendingReload=!1,this.debug=!1,this.integrations=[],this.integrationsPayload={},this.init()}registerIntegration(e){e&&typeof e.loadConfig=="function"&&typeof e.getName=="function"&&typeof e.isEnabled=="function"&&typeof e.applyConsentUpdate=="function"&&(e.loadConfig(this.integrationsPayload),e.isEnabled()&&(this.integrations.push(e),this.debug&&console.log(`[Consent Manager] Registered integration: ${e.getName()}`),e.applyConsentUpdate()))}init(){this.loadPayload(),this.loadConsentFromCookie(),this.bindEvents(),this.syncUIFromConsent(),this.updateDialogVisibility(),this.activateDeferredScripts()}loadPayload(){const e=document.querySelector('[data-consent-manager="payload"]');if(e)try{const t=JSON.parse(e.textContent);this.categories=Array.isArray(t.categories)?t.categories:[],this.buildCategoryIndex(),this.services=Array.isArray(t.services)?t.services:[],this.currentRevisionDate=t.consent_revision_date||null,this.cookieName=t.cookie_name||"consent_manager",this.cookieExpiry=t.cookie_expiry||180,this.cookiePath=t.cookie_path||"/",this.cookieDomain=t.cookie_domain||null,this.cookieSecure=t.cookie_secure===!0,this.cookieSameSite=t.cookie_same_site||"lax",this.debug=t.debug===!0,this.debug&&(console.log("[Consent Manager] Debug mode enabled"),console.log("[Consent Manager] Current revision date:",this.currentRevisionDate),console.log("[Consent Manager] Cookie name:",this.cookieName),console.log("[Consent Manager] Cookie expiry (days):",this.cookieExpiry),console.log("[Consent Manager] Cookie secure:",this.cookieSecure),console.log("[Consent Manager] Cookie same site:",this.cookieSameSite));const a=t.integrations;this.integrationsPayload=a&&typeof a=="object"&&!Array.isArray(a)?a:{}}catch(t){console.warn("Invalid consent manager payload:",t)}}buildCategoryIndex(){this.categoryIndex={},this.categories.forEach(e=>{e&&typeof e.handle=="string"&&e.handle.length&&(this.categoryIndex[e.handle]=e)})}ensureServicePreferences(){(!this.consentData.services||typeof this.consentData.services!="object")&&(this.consentData.services={}),this.services.forEach(e=>{if(!(!e||typeof e.handle!="string"||!e.handle.length)&&!(e.handle in this.consentData.services)){let t=!1;e.categories&&e.categories.length>0&&(t=e.categories.some(a=>{const s=this.categoryIndex[a];return s&&s.required})),this.consentData.services[e.handle]=t}})}applyAllIntegrationUpdates(){this.debug&&console.log(`[Consent Manager] Applying updates to ${this.integrations.length} integration(s)`),this.integrations.forEach(e=>{e.isEnabled()&&e.applyConsentUpdate()})}loadConsentFromCookie(){const e=this.getCookie(this.cookieName);if(e)try{const t=JSON.parse(e);this.consentData={services:t.services||{},revision_date:t.revision_date||null}}catch(t){console.warn("Invalid consent cookie:",t)}else this.consentData.services=this.consentData.services||{};this.ensureServicePreferences()}saveConsentToCookie(){this.consentData.revision_date=this.currentRevisionDate;const e=JSON.stringify(this.consentData),t=new Date;t.setTime(t.getTime()+this.cookieExpiry*24*60*60*1e3);const a="expires="+t.toUTCString();let s=`${this.cookieName}=${e};${a};path=${this.cookiePath}`;this.cookieDomain&&(s+=`;domain=${this.cookieDomain}`),this.cookieSecure&&(s+=";secure"),s+=`;SameSite=${this.cookieSameSite.charAt(0).toUpperCase()+this.cookieSameSite.slice(1)}`,document.cookie=s,this.debug&&(console.log("[Consent Manager] Saved consent with revision date:",this.currentRevisionDate),console.log("[Consent Manager] Cookie attributes:",{path:this.cookiePath,domain:this.cookieDomain,secure:this.cookieSecure,sameSite:this.cookieSameSite}))}getCookie(e){const t=e+"=",a=(document.cookie||"").split(";");for(let s=0;s<a.length;s++){let i=a[s];for(;i.charAt(0)===" ";)i=i.substring(1);if(i.indexOf(t)===0)return i.substring(t.length,i.length)}return null}bindEvents(){const e=document.querySelector('[data-consent-manager="banner"]'),t=document.querySelector('[data-consent-manager="preferences"]');e?.querySelectorAll("[data-consent-manager-action]")?.forEach(n=>{n.addEventListener("click",()=>{const o=n.getAttribute("data-consent-manager-action");if(o==="customize"){this.openPreferencesDialog();return}const r=this.handleAction(o);["accept-all","reject-all"].includes(o)&&this.closeDialogs(),r&&this.requestPageReload()})}),t?.querySelectorAll("[data-consent-manager-action]")?.forEach(n=>{n.addEventListener("click",()=>{const o=n.getAttribute("data-consent-manager-action"),r=this.handleAction(o);["save","accept-all","reject-all"].includes(o)&&this.closeDialogs(),r&&this.requestPageReload()})}),(t?.querySelectorAll("[data-consent-accordion-toggle]")||[]).forEach(n=>{n.addEventListener("click",()=>{const o=n.closest("[data-consent-category]")?.querySelector("[data-consent-accordion-panel]");if(!o)return;const r=o.hasAttribute("hidden");r?o.removeAttribute("hidden"):o.setAttribute("hidden","");const c=n.querySelector("[data-accordion-label]");c&&(c.textContent=r?"Hide services":"Show services")})}),(t?.querySelectorAll("[data-consent-manager-service-toggle]")||[]).forEach(n=>{n.addEventListener("change",()=>{const o=n.getAttribute("data-consent-manager-service-toggle"),r=n.checked;this.syncServiceToggles(o,r,n)})}),(t?.querySelectorAll("[data-consent-manager-toggle]")||[]).forEach(n=>{n.addEventListener("click",o=>{if(n.hasAttribute("data-required")&&n.getAttribute("data-required")==="true"||!n.indeterminate)return;const c=n.getAttribute("data-consent-manager-toggle"),l=n.closest(`[data-consent-category="${c}"]`);l&&(o.preventDefault(),n.dataset.skipNextCategoryChange="true",this.applyCategoryToggle(l,n,!0),n.dispatchEvent(new Event("change",{bubbles:!0})))}),n.addEventListener("change",()=>{if(n.hasAttribute("data-required")&&n.getAttribute("data-required")==="true")return;if(n.dataset.skipNextCategoryChange==="true"){delete n.dataset.skipNextCategoryChange;return}const r=n.getAttribute("data-consent-manager-toggle"),c=n.closest(`[data-consent-category="${r}"]`);c&&this.applyCategoryToggle(c,n,n.checked)})}),t?.addEventListener("cancel",n=>{n.preventDefault(),this.closePreferencesDialog()}),t?.addEventListener("click",n=>{const o=t.getBoundingClientRect();n.clientX>=o.left&&n.clientX<=o.right&&n.clientY>=o.top&&n.clientY<=o.bottom||this.closePreferencesDialog()}),document.addEventListener("click",n=>{const o=n.target.closest("[data-give-consent]");if(!o)return;const r=o.getAttribute("data-give-consent");r&&this.grantConsentToService(r)})}openBannerDialog(){const e=document.querySelector('[data-consent-manager="banner"]');e&&!e.open&&e.show()}openPreferencesDialog(){const e=document.querySelector('[data-consent-manager="banner"]'),t=document.querySelector('[data-consent-manager="preferences"]');e?.close(),t?.showModal(),this.syncUIFromConsent()}closePreferencesDialog(){document.querySelector('[data-consent-manager="preferences"]')?.close()}closeDialogs(){const e=document.querySelector('[data-consent-manager="banner"]'),t=document.querySelector('[data-consent-manager="preferences"]');e?.close(),t?.close()}handleAction(e){const t=this.getCookie(this.cookieName)!==null,a=this.getAllConsent();switch(e){case"accept-all":this.services.forEach(n=>{!n||!n.handle||(this.consentData.services[n.handle]=!0)});break;case"reject-all":this.consentData={services:{},revision_date:null},this.services.forEach(n=>{!n||!n.handle||(this.consentData.services[n.handle]=!1)});break;case"save":document.querySelectorAll('[data-consent-manager="preferences"] [data-consent-manager-service-toggle]')?.forEach(n=>{const o=n.getAttribute("data-consent-manager-service-toggle");if(!o)return;const r=n.checked;this.consentData.services[o]=r});break;default:return!1}this.ensureServicePreferences(),this.saveConsentToCookie(),this.syncUIFromConsent(),this.updateDialogVisibility(),this.dispatchUpdateEvent(),this.activateDeferredScripts(),this.applyAllIntegrationUpdates();const s=t?this.detectRevocations(a,this.consentData):!1;return this.pendingReload=s,s}syncServiceToggles(e,t,a=null){if(!e)return;(document.querySelectorAll(`[data-consent-manager-service-toggle="${e}"]`)||[]).forEach(i=>{a&&i===a||i instanceof HTMLInputElement&&(i.disabled||(i.checked=t))}),this.recalculateCategoriesForService(e)}applyCategoryToggle(e,t,a){if(t.hasAttribute("data-required")&&t.getAttribute("data-required")==="true")return;t.indeterminate=!1,t.checked=a,e.querySelectorAll("[data-consent-manager-service-toggle]").forEach(n=>{if(n instanceof HTMLInputElement&&!n.disabled){n.checked=a;const o=n.getAttribute("data-consent-manager-service-toggle");this.syncServiceToggles(o,n.checked,n)}}),this.recalculateCategoryState(e)}syncUIFromConsent(){document.querySelectorAll("[data-consent-manager-service-toggle]").forEach(t=>{const a=t.getAttribute("data-consent-manager-service-toggle");if(a in(this.consentData.services||{}))t.checked=!!this.consentData.services[a];else{const s=this.services.find(i=>i.handle===a);if(s&&s.categories&&s.categories.length>0){const i=s.categories.some(n=>{const o=this.categoryIndex[n];return o&&o.default_enabled});t.checked=i}}}),this.recalculateAllCategoryStates()}recalculateAllCategoryStates(){(document.querySelectorAll("[data-consent-category]")||[]).forEach(t=>this.recalculateCategoryState(t))}recalculateCategoriesForService(e){const t=document.querySelectorAll(`[data-consent-manager-service-toggle="${e}"]`)||[],a=new Set;t.forEach(s=>{const i=s.closest("[data-consent-category]");i&&a.add(i)}),a.forEach(s=>this.recalculateCategoryState(s))}recalculateCategoryState(e){const t=e.querySelector("[data-consent-manager-toggle]");if(!t)return;const a=t.hasAttribute("data-required")&&t.getAttribute("data-required")==="true",s=Array.from(e.querySelectorAll("[data-consent-manager-service-toggle]")).filter(r=>r instanceof HTMLInputElement);if(a){t.checked=!0,t.indeterminate=!1;return}if(s.length===0){t.indeterminate=!1,t.checked=!1;return}const i=s.reduce((r,c)=>r+(c.checked?1:0),0),n=i===s.length,o=i===0;t.indeterminate=!1,n?t.checked=!0:o?t.checked=!1:(t.checked=!1,t.indeterminate=!0)}updateDialogVisibility(){const e=this.getCookie(this.cookieName)!==null,t=this.needsReconsent(),a=document.querySelector('[data-consent-manager="banner"]'),s=document.querySelector('[data-consent-manager="preferences"]');e&&!t?(a?.close(),s?.close()):(this.openBannerDialog(),s?.close()),this.debug&&t&&console.log("[Consent Manager] Re-consent required - revision date changed")}needsReconsent(){return this.currentRevisionDate?this.consentData.revision_date?this.consentData.revision_date!==this.currentRevisionDate:!0:!1}dispatchUpdateEvent(){const e={consentData:this.consentData},t=this.integrations.filter(s=>s.isEnabled());t.length>0&&(e.integrations={},t.forEach(s=>{const i=s.getState();i&&(e.integrations[s.getName()]=i)}));const a=new CustomEvent("consent-manager:preferences-updated",{detail:e});document.dispatchEvent(a)}activateDeferredScripts(){this.getCookie(this.cookieName)!==null&&this.services.forEach(t=>{t.handle&&this.getServiceConsent(t.handle)&&this.activateTemplatesForService(t.handle)})}activateTemplatesForService(e){if(!e)return;document.querySelectorAll(`template[data-consent-manager-script][data-service-handle="${e}"]`).forEach(a=>{document.querySelector(`[data-consent-placeholder="${e}"]`)?.remove(),a.before(a.content),a.remove()})}detectRevocations(e,t){const a=e?.services||{},s=t?.services||{};return Object.keys(a).some(n=>a[n]===!0&&s[n]!==!0)}requestPageReload(){this.pendingReload&&(this.pendingReload=!1,window.setTimeout(()=>window.location.reload(),100))}grantConsentToService(e){e&&(this.consentData.services||(this.consentData.services={}),this.consentData.services[e]=!0,this.saveConsentToCookie(),this.activateTemplatesForService(e),this.dispatchUpdateEvent(),this.applyAllIntegrationUpdates(),this.debug&&console.log(`[Consent Manager] Granted consent to service: ${e}`))}getServiceConsent(e){return!this.consentData||!this.consentData.services?!1:this.consentData.services[e]===!0}showBanner(){this.openBannerDialog()}showPreferences(){this.openPreferencesDialog()}getAllConsent(){return JSON.parse(JSON.stringify(this.consentData))}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.consentManager=new d}):window.consentManager=new d;
